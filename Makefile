# =============================================================================
# –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ - Makefile
# =============================================================================

.PHONY: help build clean install dev test check

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
NODE = node
NPM = npm
YARN = yarn
DIST_DIR = dist
DATA_DIR = data

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
BLUE = \033[0;34m
NC = \033[0m # No Color
BOLD = \033[1m

# =============================================================================
# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
# =============================================================================

## help: –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º
help:
	@echo "$(BOLD)$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BOLD)$(BLUE)  –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤$(NC)"
	@echo "$(BOLD)$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(BOLD)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@echo ""
	@echo "  $(GREEN)make build$(NC)        - –°–æ–±—Ä–∞—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤"
	@echo "  $(GREEN)make clean$(NC)        - –û—á–∏—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É dist/"
	@echo "  $(GREEN)make install$(NC)      - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (yarn install)"
	@echo "  $(GREEN)make dev$(NC)          - –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (build + watch)"
	@echo "  $(GREEN)make check$(NC)        - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤"
	@echo "  $(GREEN)make help$(NC)         - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
	@echo ""
	@echo "$(BOLD)–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:$(NC)"
	@echo ""
	@echo "  $(YELLOW)make build$(NC)              # –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
	@echo "  $(YELLOW)make clean && make build$(NC) # –û—á–∏—Å—Ç–∏—Ç—å –∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å"
	@echo "  $(YELLOW)make install && make build$(NC) # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–æ–±—Ä–∞—Ç—å"
	@echo ""

## build: –°–æ–±—Ä–∞—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É
build:
	@echo "$(BOLD)$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BOLD)$(BLUE)  –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...$(NC)"
	@echo "$(BOLD)$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@if [ ! -d "$(DATA_DIR)" ]; then \
		echo "$(RED)‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ $(DATA_DIR) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f "main.js" ]; then \
		echo "$(RED)‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª main.js –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f "template.html" ]; then \
		echo "$(RED)‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª template.html –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"; \
		exit 1; \
	fi
	@$(NODE) main.js
	@echo ""
	@echo "$(GREEN)‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!$(NC)"
	@echo "$(BLUE)üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç: $(DIST_DIR)/index.html$(NC)"

## clean: –û—á–∏—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É dist/
clean:
	@echo "$(YELLOW)üßπ –û—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏ dist/...$(NC)"
	@if [ -d "$(DIST_DIR)" ]; then \
		rm -rf $(DIST_DIR)/*; \
		echo "$(GREEN)‚úÖ –ü–∞–ø–∫–∞ $(DIST_DIR) –æ—á–∏—â–µ–Ω–∞$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  –ü–∞–ø–∫–∞ $(DIST_DIR) –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç$(NC)"; \
	fi

## install: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
install:
	@echo "$(BLUE)üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	@if command -v $(YARN) > /dev/null 2>&1; then \
		$(YARN) install; \
		echo "$(GREEN)‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é yarn$(NC)"; \
	elif command -v $(NPM) > /dev/null 2>&1; then \
		$(NPM) install; \
		echo "$(GREEN)‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é npm$(NC)"; \
	else \
		echo "$(RED)‚ùå –û—à–∏–±–∫–∞: yarn –∏–ª–∏ npm –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"; \
		exit 1; \
	fi

## dev: –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Å–±–æ—Ä–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
dev: check build
	@echo ""
	@echo "$(GREEN)‚úÖ –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω$(NC)"
	@echo "$(BLUE)üí° –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:$(NC)"
	@echo "$(YELLOW)   watchman-make -p 'data/**/*.md' 'data/**/*.yaml' 'main.js' 'template.html' -t build$(NC)"
	@echo "$(YELLOW)   –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ nodemon: npm install -g nodemon && nodemon --watch data --watch main.js --watch template.html main.js$(NC)"

## check: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
check:
	@echo "$(BLUE)üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞...$(NC)"
	@errors=0; \
	if [ ! -f "main.js" ]; then \
		echo "$(RED)‚ùå main.js –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"; \
		errors=$$((errors + 1)); \
	else \
		echo "$(GREEN)‚úÖ main.js –Ω–∞–π–¥–µ–Ω$(NC)"; \
	fi; \
	if [ ! -f "template.html" ]; then \
		echo "$(RED)‚ùå template.html –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"; \
		errors=$$((errors + 1)); \
	else \
		echo "$(GREEN)‚úÖ template.html –Ω–∞–π–¥–µ–Ω$(NC)"; \
	fi; \
	if [ ! -d "$(DATA_DIR)" ]; then \
		echo "$(RED)‚ùå –ø–∞–ø–∫–∞ $(DATA_DIR) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
		errors=$$((errors + 1)); \
	else \
		echo "$(GREEN)‚úÖ –ø–∞–ø–∫–∞ $(DATA_DIR) –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
	fi; \
	if [ ! -f "$(DATA_DIR)/header.md" ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  $(DATA_DIR)/header.md –Ω–µ –Ω–∞–π–¥–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ $(DATA_DIR)/header.md –Ω–∞–π–¥–µ–Ω$(NC)"; \
	fi; \
	if [ ! -f "$(DATA_DIR)/config.yaml" ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  $(DATA_DIR)/config.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ $(DATA_DIR)/config.yaml –Ω–∞–π–¥–µ–Ω$(NC)"; \
	fi; \
	text_files=$$(find $(DATA_DIR) -name "text-*.md" 2>/dev/null | wc -l); \
	if [ $$text_files -eq 0 ]; then \
		echo "$(RED)‚ùå –§–∞–π–ª—ã —è–∑—ã–∫–æ–≤ (text-*.md) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"; \
		errors=$$((errors + 1)); \
	else \
		echo "$(GREEN)‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ —è–∑—ã–∫–æ–≤: $$text_files$(NC)"; \
	fi; \
	if [ $$errors -gt 0 ]; then \
		echo ""; \
		echo "$(RED)‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏: $$errors$(NC)"; \
		exit 1; \
	else \
		echo ""; \
		echo "$(GREEN)‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ$(NC)"; \
	fi

# =============================================================================
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
# =============================================================================

## rebuild: –û—á–∏—Å—Ç–∏—Ç—å –∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
rebuild: clean build

## all: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–æ–±—Ä–∞—Ç—å
all: install build

## info: –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
info:
	@echo "$(BOLD)$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BOLD)$(BLUE)  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ$(NC)"
	@echo "$(BOLD)$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(BOLD)–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:$(NC)"
	@echo "  $(BLUE)data/$(NC)          - –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã (markdown, yaml)"
	@echo "  $(BLUE)dist/$(NC)          - –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏ (HTML)"
	@echo "  $(BLUE)main.js$(NC)        - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä HTML"
	@echo "  $(BLUE)template.html$(NC)  - HTML —à–∞–±–ª–æ–Ω"
	@echo ""
	@if [ -d "$(DIST_DIR)" ]; then \
		echo "$(BOLD)–†–∞–∑–º–µ—Ä dist/:$(NC)"; \
		du -sh $(DIST_DIR) 2>/dev/null || echo "  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å"; \
	fi
	@echo ""
	@if [ -d "node_modules" ]; then \
		echo "$(BOLD)–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:$(NC)"; \
		$(YARN) list --depth=0 2>/dev/null || $(NPM) list --depth=0 2>/dev/null || echo "  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫"; \
	fi

# –ö–æ–º–∞–Ω–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
.DEFAULT_GOAL := help

